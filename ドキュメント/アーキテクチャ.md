# アーキテクチャ概要（新）

## 全体像
- **フロントエンド**: Vite + React（`frontend/`）。開発時は Vite dev server (:8080)、本番は Caddy で `dist` を配信し `/api/*` を api:3000 へリバースプロキシ。
- **API**: Gin ベースの REST。Cookie セッション + CSRF トークン必須。DB への CRUD、ファイル保存、キュー投入を担当。
- **Worker**: Redis キューから submission_id を取得し、go-judge へ実行要求。結果を DB に書き戻し、提出ファイルを更新。
- **go-judge**: コンテナ内でコードを実行・採点（HTTP :5050 / gRPC :5051 / metrics :5052）。並列度は `-parallelism` で設定。
- **Redis**: 提出キュー。`pending_submissions`（List）と `processing_submissions`（ZSET）で可視タイムアウトを実現。
- **PostgreSQL**: ユーザー、問題、提出、結果メタを保持。問題文・テストケース本文は基本 inline カラム（`statement_md`, `input_text`, `output_text`）。
- **ストレージ**: `submission-files`（提出ソース・出力）、`judge-file-store`（go-judge copyOut）、`secrets`（セッション/CSRF鍵）、`logs`（API/worker）。

## 主要ポートと役割
- 8080: Vite dev server（開発 UI）
- 3000: API (Gin)
- 5050/5051/5052: go-judge HTTP / gRPC / metrics
- 5432: PostgreSQL
- 6379: Redis

## データフロー
### 提出
1. SPA から `/api/v1/submissions` に提出（CSRF トークン付き）。
2. API がソースを `submission-files` に保存し、DB に `pending` で登録。
3. submission_id を Redis `pending_submissions` へ enqueue。
4. Worker が dequeue→ go-judge に実行依頼（並列度は `WORKER_CONCURRENCY` と揃える）。
5. go-judge が stdout/stderr を copyOut。Worker が DB を `succeeded/failed` で更新。
6. クライアントはポーリング（将来的に SSE/WebSocket 予定）で結果取得。

### 問題インポート
- 管理者が ZIP をアップロード → API が解凍し、問題文・テストケースを inline で DB 登録 → 公開フラグで一覧に反映。
- テンプレート配布: `/api/v1/admin/problems/template` が slug 付きフォルダ構成の ZIP を返す。再圧縮すればそのままアップロード可。

## セキュリティ境界
- **セッション/Cookie**: HttpOnly、MaxAge=5h。`COOKIE_SECURE`/`COOKIE_SAMESITE` で挙動変更。
- **CSRF**: 非 Safe メソッドは `X-CSRF-Token` 必須。レスポンスヘッダーで常に新トークンを返す。
- **CORS/Origin**: `ALLOWED_ORIGINS` と一致しない Origin を 403。許可 Origin のみ CORS ヘッダーを付与。

## スケールと運用ポイント
- Worker は `WORKER_CONCURRENCY` で水平スケール可。go-judge の `-parallelism` を同値にする。
- Redis キューは可視タイムアウト方式。`retry_count` で再実行回数を DB 管理。
- 永続化すべきもの: PostgreSQL データ、`submission-files`、`judge-file-store`、`logs`、`secrets`。

## データモデル（概要）
- users: username(unique), role(user/admin), password_hash, timestamps
- problems: slug(unique), title, statement_md, time_limit_ms, memory_limit_kb, is_public
- testcases: problem_id, input_text, output_text, is_sample
- submissions: user_id, problem_id, language, source_path, status(pending/running/succeeded/failed), retry_count
- submission_results: submission_id, verdict(AC/WA/TLE/MLE/RE/CE/SE), time_ms, memory_kb, stdout_path, stderr_path, exit_code, error_message
