# 環境構築と使い方（ローカル）

ローカルでオンラインジャッジ一式を起動し、基本操作を行うまでの手順をまとめます。Docker Compose 前提です。

## 前提
- Docker / Docker Compose がインストール済み
- 空けておくポート: 3000 (API), 5050-5052 (go-judge), 8080 (UI dev), 5432 (PostgreSQL)
  - Redis (6379) はコンテナ内部通信のみでホストには公開されない
- リポジトリ取得済み: `git clone ... && cd tuis-oj-base`

### 1. リポジトリを取得
```bash
git clone https://github.com/asfrgrtgd/tuis-oj-base.git
cd tuis-oj-base
```

### 2. 環境変数を設定
```bash
cp .env.example .env
cp frontend/.env.example frontend/.env
```
> ローカル開発ならデフォルトで OK。本番では `.env` 内の `SESSION_KEY` と `CSRF_SECRET` を必ず変更してください。

### 3. ファイルパーミッションの設定（Linux/WSL2 のみ）
API/Worker コンテナは `appuser`（uid:65532）で動作します。提出ファイルやログ、シークレットが保存されるディレクトリの所有者を事前に設定してください。

```bash
sudo chown -R 65532:65532 submission-files logs secrets
sudo chmod -R u+rwX submission-files logs secrets
```

> **注**: macOS の Docker Desktop では不要です。

### 4. コンテナをビルド・起動
```bash
docker compose up -d --build
```

### 5. DB マイグレーション（初回のみ）
```bash
POSTGRES_URL="postgres://tuisoj:tuisoj@db:5432/tuisoj?sslmode=disable"
docker compose run --rm --entrypoint migrate \
  -e POSTGRES_URL="$POSTGRES_URL" \
  api -path=/migrations -database "$POSTGRES_URL" up
```

### 6. 動作確認
| サービス | URL |
|---------|-----|
| Web UI (dev) | http://localhost:8080 |

### 7. 初期管理者でログイン
`BOOTSTRAP_ADMIN=true`（デフォルト）の場合、初回起動時に `admin` ユーザーが自動作成されます。
```bash
cat secrets/initial_admin_password.secret
```
このパスワードで http://localhost:8080 からログインできます。

## 8. 使い方

### ログイン
1. ブラウザで http://localhost:8080 を開く。
2. 初期 admin パスワードは `./secrets/initial_admin_password.secret` を参照。
3. 一般ユーザーは管理画面から CSV 一括追加、または API で登録。

### 受験者フロー
1. 問題一覧から問題を選択し、説明を確認。
2. ソースコードと言語を指定して提出。
3. 提出詳細でステータス（pending → running → succeeded/failed）を確認。
4. 判定とstdoutを確認。

### 管理者フロー
- 問題インポート: 管理画面の「問題インポート」で ZIP をアップロード。テンプレートは `/api/v1/admin/problems/template` から取得可。
- ユーザー管理: CSV 一括追加でユーザー登録。role=admin で管理者追加。
- メトリクス: 管理ダッシュボードでキュー長・ワーカー状態を確認。
- お知らせ: `/api/v1/admin/notices` で作成するとフロント「お知らせ」に表示。
