# 環境構築と使い方（ローカル）

ローカルでオンラインジャッジ一式を起動し、基本操作を行うまでの手順をまとめます。Docker Compose 前提です。

## 前提
- Docker / Docker Compose がインストール済み
- 空けておくポート: 3000 (API), 5050-5052 (go-judge), 8080 (UI dev), 5432 (PostgreSQL)
  - Redis (6379) はコンテナ内部通信のみでホストには公開されない
- リポジトリ取得済み: `git clone ... && cd tuis-oj-base`

## 1. 環境変数を用意
`.env` をルートに置き、最低限以下を設定します。
```
POSTGRES_URL=postgres://tuisoj:tuisoj@db:5432/tuisoj?sslmode=disable
DATABASE_URL=${POSTGRES_URL}
REDIS_URL=redis://redis:6379/0
GOJUDGE_URL=http://go-judge:5050
SESSION_KEY=change-me-session
CSRF_SECRET=change-me-csrf
ALLOWED_ORIGINS=http://localhost:8080,http://localhost:3000
BOOTSTRAP_ADMIN=true
```

## 2. ビルド（初回のみ）
```bash
docker compose build
```

## 3. 起動
```bash
docker compose up -d
```

## 4. DB 初期化（DB が空のときだけ）
```bash
POSTGRES_URL="postgres://tuisoj:tuisoj@db:5432/tuisoj?sslmode=disable" \
docker compose run --rm --entrypoint migrate \
  -e POSTGRES_URL="$POSTGRES_URL" \
  api -path=/migrations -database "$POSTGRES_URL" up
```

## 5. 動作確認
- Web UI: http://localhost:8080

## 6. 初期データ
- `BOOTSTRAP_ADMIN=true` かつ admin 不在なら、起動時に `admin` を自動作成し、パスワードを `./secrets/initial_admin_password.secret` に出力。
- `migrations/0200_seed_problems` でサンプル問題を投入。不要なら適用前に SQL を調整。

## 7. 使い方
### ログイン
1. ブラウザで http://localhost:8080 を開く。
2. 初期 admin パスワードは `./secrets/initial_admin_password.secret` を参照。
3. 一般ユーザーは管理画面から CSV 一括追加、または API で登録。

### 受験者フロー
1. 問題一覧から問題を選択し、説明を確認。
2. ソースコードと言語を指定して提出。
3. 提出詳細でステータス（pending → running → succeeded/failed）を確認。
4. 判定とstdoutを確認。

### 管理者フロー
- 問題インポート: 管理画面の「問題インポート」で ZIP をアップロード。テンプレートは `/api/v1/admin/problems/template` から取得可。
- ユーザー管理: CSV 一括追加でユーザー登録。role=admin で管理者追加。
- メトリクス: 管理ダッシュボードでキュー長・ワーカー状態を確認。
- お知らせ: `/api/v1/admin/notices` で作成するとフロント「お知らせ」に表示。
