# アーキテクチャ構成図（2025-12-25 詳細版）

```mermaid
flowchart LR
    subgraph Client
        B["Browser / SPA"]
    end

    subgraph Edge [フロント配信]
        Caddy["Caddy<br/>:80 / :443<br/>SPA 配信 /api プロキシ"]
        Vite["Vite dev server<br/>:8080 (開発時)"]
    end

    subgraph Backend [Backend docker compose]
        API["api (Gin)<br/>:3000"]
        Worker["worker<br/>(WORKER_CONCURRENCY=n)"]
        Redis[(Redis 7)]
        DB[(PostgreSQL)]
        Judge["go-judge<br/>:5050 http / :5051 gRPC<br/>:5052 metrics"]

        subgraph Storage [共有ストレージ]
            SubFiles["submission-files<br/>提出ソース/結果"]
            JudgeFS["judge-file-store<br/>(go-judge copyOut)"]
        end

        Secrets["/run/oj-secrets<br/>SESSION_KEY, CSRF_SECRET"]
        Logs["logs/api<br/>logs/worker"]
    end

    B -- HTTPS --> Caddy
    B -- HTTP(S) --> Vite
    Caddy -- "/api/*" --> API
    Vite -- "/api/*" --> API
    Caddy -- "SPA 静的配信" --> B

    API -- enqueue --> Redis
    Worker -- dequeue/ack --> Redis
    API -- CRUD/meta --> DB
    Worker -- results --> DB
    API -- store/read --> SubFiles
    Worker -- read/write --> SubFiles
    Worker -- run --> Judge
    Judge -- copyOut --> JudgeFS
    API -. secrets .-> Secrets
    API -. logs .-> Logs
    Worker -. logs .-> Logs

    classDef svc fill:#eef4ff,stroke:#1d4ed8,stroke-width:1;
    classDef db fill:#fef9c3,stroke:#ca8a04,stroke-width:1;
    classDef storage fill:#ecfdf3,stroke:#16a34a,stroke-width:1;
    class API,Worker,Judge,Redis svc;
    class DB db;
    class SubFiles,JudgeFS storage;
```

- worker は `WORKER_CONCURRENCY` でスケールアウト（go-judge の `-parallelism` と揃える）。
- Redis は `pending_submissions`（List）と `processing_submissions`（ZSET）に分離し、可視タイムアウトで再キューイング。
- 本番は Caddy が dist を配信し `/api/*` を api:3000 にプロキシ。開発時は Vite dev server から直接 API を叩く。

## 提出シーケンス（本番）

```mermaid
sequenceDiagram
    participant B as Browser (SPA)
    participant C as Caddy
    participant A as API (Gin)
    participant R as Redis queue
    participant W as Worker
    participant J as go-judge
    participant D as PostgreSQL
    participant F as submission-files

    B->>C: POST /api/v1/submissions + CSRF Cookie
    C->>A: reverse_proxy
    A->>F: ソース保存
    A->>D: submissions INSERT (status=pending)
    A->>R: enqueue submission_id
    W-->>R: BRPOP/claim (visibility timeout)
    W->>D: status=running (FOR UPDATE)
    W->>J: run (parallelism=N)
    J-->>W: stdout/stderr (response)
    W->>F: 結果保存
    W->>D: submission_results upsert + status 更新
    B-->>C: GET /api/v1/submissions/:id (poll)
    C-->>A: forward
    A-->>B: status/result
```
